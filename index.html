<!DOCTYPE html>
<html>
<head>
  <title>Motion Detector</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    video, canvas { display: block; margin: 0 auto; }
    h1 { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Bobblehead Motion Detector</h1>
  <video id="video" width="320" height="240" autoplay muted playsinline></video>
  <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
  <p>Hit Kavoosi in the head!</p>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const audio = new Audio('digital.mp3');

    const frameBuffer = [];
    const maxFrames = 10;
    let lastTriggerTime = 0;
    const cooldown = 2000;
    const motionThreshold = 30;
    const motionRatioThreshold = 0.05;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } }).then(stream => {
      video.srcObject = stream;
      requestAnimationFrame(detectMotion);
    }).catch(err => {
      console.error('Camera access error:', err);
    });

    function averageFrames(frames) {
      const avg = new Uint8ClampedArray(frames[0].data.length);
      for (let i = 0; i < frames[0].data.length; i++) {
        let sum = 0;
        for (let f = 0; f < frames.length; f++) {
          sum += frames[f].data[i];
        }
        avg[i] = sum / frames.length;
      }
      return new ImageData(avg, frames[0].width, frames[0].height);
    }

    function detectMotion() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const currentFrame = ctx.getImageData(80, 60, 160, 120);

      frameBuffer.push(currentFrame);
      if (frameBuffer.length > maxFrames) {
        frameBuffer.shift();
      }

      if (frameBuffer.length < maxFrames) {
        requestAnimationFrame(detectMotion);
        return; // Wait until buffer is full
      }

      const avgFrame = averageFrames(frameBuffer);
      let motionPixels = 0;

      for (let i = 0; i < currentFrame.data.length; i += 4) {
        const r = currentFrame.data[i];
        const g = currentFrame.data[i + 1];
        const b = currentFrame.data[i + 2];
        const brightness = (r + g + b) / 3;

        const ar = avgFrame.data[i];
        const ag = avgFrame.data[i + 1];
        const ab = avgFrame.data[i + 2];
        const avgBrightness = (ar + ag + ab) / 3;

        if (Math.abs(brightness - avgBrightness) > motionThreshold) {
          motionPixels++;
        }
      }

      const totalPixels = currentFrame.data.length / 4;
      const now = Date.now();

      if ((motionPixels / totalPixels) > motionRatioThreshold && (now - lastTriggerTime > cooldown)) {
        console.log('Motion detected');
        audio.play();
        lastTriggerTime = now;
      }

      requestAnimationFrame(detectMotion);
    }
  </script>
</body>
</html>
