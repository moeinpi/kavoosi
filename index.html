<!DOCTYPE html>
<html>
<head>
  <title>Motion Detector</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    video, canvas { display: block; margin: 0 auto; }
    h1 { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Bobblehead Motion Detector</h1>
  <video id="video" width="320" height="240" autoplay muted playsinline></video>
  <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
  <p>Hit Kavoosi in the head!</p>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const audio = new Audio('digital.mp3');

    let lastFrame = null;
    let lastTriggerTime = 0;
    const cooldown = 2000; // 2 seconds
    const motionThreshold = 30; // pixel brightness difference
    const motionRatioThreshold = 0.05; // 5% of center pixels

    navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } }).then(stream => {
      video.srcObject = stream;
      requestAnimationFrame(detectMotion);
    }).catch(err => {
      console.error('Camera access error:', err);
    });

    function detectMotion() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const frame = ctx.getImageData(80, 60, 160, 120); // center region only

      if (lastFrame) {
        let motionPixels = 0;

        for (let i = 0; i < frame.data.length; i += 4) {
          const r = frame.data[i];
          const g = frame.data[i + 1];
          const b = frame.data[i + 2];
          const brightness = (r + g + b) / 3;

          const lr = lastFrame.data[i];
          const lg = lastFrame.data[i + 1];
          const lb = lastFrame.data[i + 2];
          const lastBrightness = (lr + lg + lb) / 3;

          if (Math.abs(brightness - lastBrightness) > motionThreshold) {
            motionPixels++;
          }
        }

        const totalPixels = frame.data.length / 4;
        const now = Date.now();

        if ((motionPixels / totalPixels) > motionRatioThreshold && (now - lastTriggerTime > cooldown)) {
          console.log('Motion detected');
          audio.play();
          lastTriggerTime = now;
        }
      }

      lastFrame = frame;
      requestAnimationFrame(detectMotion);
    }
  </script>
</body>
</html>
